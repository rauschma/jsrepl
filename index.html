<!doctype html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>jsrepl</title>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script type="text/javascript" src="jquery.jkey.min.js"></script>
    <script type="text/javascript">
        function endsWith(str, suffix) {
            var index = str.lastIndexOf(suffix);
            return index >= 0 && index === str.length - suffix.length;
        }

        // A trailing newline is not included
        function extractLine(str, pos) {
            var begin = pos;
            while(true) {
                if (begin <= 0) break;
                if (str.charAt(begin-1) === "\n") {
                    break;
                }
                begin--;
            }
            var end = pos;
            while(true) {
                if (end >= str.length) {
                    // End of text as terminating pseudo-character
                    break;
                }
                if (str.charAt(end) === "\n") {
                    break;
                }
                end++;
            }
            return str.slice(begin, end);
        }

        function determineTextToEval(text) {
            // Prefix a newline so that search and replace is simpler
            // (remove it before returning the result)
            text = "\n" + text;

            // Variable and function declarations are handled by making them properties
            // of __environment__. Prefix whitespace if you don't want that to happen.
            text = text.replace(/\nvar\s+(\w+)\s*=/g, "\n__environment__.$1 =");
            text = text.replace(/\nfunction\s+(\w+)/g, "\n__environment__.$1 = function");

            return text.slice(1);
        }

        function computeResult(textToEval, __environment__) {
            try {
                with (__environment__) {  // ugly, but work-arounds are complicated
                    var result = eval(textToEval);
                    return JSON.stringify(result, null, 4)+"\n";
                }
            } catch (e) {
                return e+"\n";
            }
        }

        function extractText(textArea) {
            if (textArea.selectionStart === textArea.selectionEnd) {
                return extractLine(textArea.value, textArea.selectionStart);
            } else {
                return textArea.value.slice(textArea.selectionStart, textArea.selectionEnd);
            }
        }

        function appendResultStr(textArea, feedbackStr) {
            if (!endsWith(textArea.value, "\n")) {
                feedbackStr = "\n" + feedbackStr;
            }
            textArea.value = textArea.value + feedbackStr;
        }

        function init() {
            var environment = {};
            var textArea = $("#content").get(0);
            $("#content").jkey('shift+return', function () {
                var text = extractText(textArea);
                var textToEval = determineTextToEval(text);
                var resultStr = computeResult(textToEval, environment);

                appendResultStr(textArea, resultStr);
            });
            $("#example").click(function () {
                textArea.value = (
                    '// Code: select and evaluate first (via Shift-Return)\n' +
                    'function twice(x) {\n' +
                    '    return x + x;\n' +
                    '}\n' +
                    '\n' +
                    '// Examples: put cursor somewhere in the line, hit Shift-Return to evaluate \n' +
                    'twice(123)\n' +
                    'twice("abc")\n'
                );
                return false;
            });
        }
        $(document).ready(init);
    </script>
</head>
<body>

<h1>jsrepl</h1>

<p>
Shift-Return: evaluate selection or current line. [<a href="" id="example">Insert example</a>]
</p>

<textarea id="content" rows="40" cols="80"></textarea>
<p>
Project <a href="https://github.com/rauschma/jsrepl">jsrepl</a> on GitHub.
</p>
</body>
</html>